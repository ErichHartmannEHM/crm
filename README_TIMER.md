
# Телеграм‑таймер по статусу In Work — патч

В этом архиве исправлено и улучшено поведение рассылки по таймеру для чатов работников с опцией
«Отправлять только по картам в статусе In work».

## Что сделано

- Полностью переработан выбор чатов для рассылки, когда включён флажок **only_inwork**.
- Теперь поддерживаются **все варианты связей** работника и карт:
  1) `cards.drop_id` → `drops.id` (основной путь);
  2) таблица связей `drop_cards` (`drop_cards.drop_id` → `cards.id`);
  3) фолбэк по имени: `cards.drop_name` = `drops.name` (на случай старых баз).

- Нормализована проверка статуса карты: учитываются `in_work`, `inwork`, `in work`,
  а также русск/укр варианты `в работе`/`в роботе`/`У роботі`.

- Логика вынесена в **две** основные точки, как вы просили:
  - `admin/telegram.php` (страница настроек таймеров)
  - `cron/telegram_dispatch.php` (исполнитель отправок по расписанию)

Другие файлы не трогались.

## Какие файлы изменены

- `admin/telegram.php`
- `cron/telegram_dispatch.php`

В обоих файлах заменена функция:

```php
function tg_list_drop_chats_inwork(): array
```

Она теперь:
- автоматически определяет, какие таблицы/колонки есть в базе,
- строит универсальный `JOIN`,
- возвращает список активных чатов работников, у которых есть **хотя бы одна карта** в статусе In Work.

## Как пользоваться

1. В админке откройте **Telegram — рассылки**.
2. Создайте таймер в блоке **«чаты работников — таймер»**,
   отметьте `Отправлять только по картам в статусе «In work»`.
3. Убедитесь, что у нужных работников есть:
   - хотя бы одна карта со статусом `in_work` (или эквиваленты),
   - и привязка чата в блоке **Аккаунты работников → Привязка чатов**.

## Cron

Для работы отправок используйте cron‑задачу, например:

```
* * * * * /usr/bin/php -d detect_unicode=0 /path/to/project/cron/telegram_dispatch.php >/dev/null 2>&1
```

Скрипт сам проверяет расписание (время HH:MM), маску отправок за день и флаг `only_inwork`.

## Диагностика

Логи пишутся в `storage/logs/telegram/broadcast_YYYYMMDD.log`.

Если таймер отмечен как «только In Work», но отправок нет:
- проверьте, что у работника реально есть карты в статусе `in_work`/`inwork`/`in work`/`У роботі`;
- проверьте наличие связей: `cards.drop_id`, таблица `drop_cards`, или заполнено `cards.drop_name`;
- убедитесь, что чат привязан и помечен как активный (`drop_telegram_chats.is_active=1`).

## Обратная совместимость

Если база старая (нет `drop_id` или `drop_cards`) — будет использован фолбэк
по имени работника через `cards.drop_name = drops.name`.

